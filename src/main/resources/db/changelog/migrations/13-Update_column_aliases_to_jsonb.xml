<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.4.xsd">

  <changeSet id="13" author="dina-export-api" context="schema-change">
    <comment>Convert columnAliases from string array to jsonb to support nested structure</comment>
    
    <!-- For data_export table -->
    <sql>
      ALTER TABLE export.data_export 
      ALTER COLUMN column_aliases TYPE JSONB 
      USING to_jsonb(column_aliases)
    </sql>
    
    <!-- For data_export_template table -->
    <sql>
      ALTER TABLE export.data_export_template 
      ALTER COLUMN column_aliases TYPE JSONB 
      USING to_jsonb(column_aliases)
    </sql>
    
    <rollback>
      <sql>
        ALTER TABLE export.data_export 
        ALTER COLUMN column_aliases TYPE text[] 
        USING ARRAY(SELECT jsonb_array_elements_text(column_aliases))
      </sql>
      <sql>
        ALTER TABLE export.data_export_template 
        ALTER COLUMN column_aliases TYPE text[] 
        USING ARRAY(SELECT jsonb_array_elements_text(column_aliases))
      </sql>
    </rollback>
  </changeSet>

</databaseChangeLog>
